# SillyTavern Web部署向导 - Requirements Confirmation

## Feature Name
`sillytavern-web-deployment-wizard`

## 原始需求总结
将现有的SillyTavern管理控制台从"检测到Docker缺失直接报错"转换为完整的web端交互式部署向导，基于 `linux-silly-tavern-docker-deploy.sh` 脚本的功能，为非技术用户提供傻瓜式的一键部署体验。

## 问题陈述分析

### 当前痛点
1. **断点式用户体验**：现有系统检测到Docker缺失后直接中断，无法引导用户完成安装
2. **技术门槛过高**：需要用户手动执行shell脚本，对初学者不友好
3. **功能割裂**：shell脚本功能完整（530+行），但web界面功能简陋
4. **交互体验差**：缺乏进度反馈、错误恢复、配置确认等用户友好功能

### 业务目标
- **目标用户**：非技术背景的"小白用户"，无Linux命令行经验
- **核心价值**：将复杂的Linux部署流程转换为可视化、交互式的web体验
- **成功标准**：用户仅通过点击和简单配置即可完成SillyTavern完整部署

## 需求质量评估

### 1. 功能明确性 (30分)

#### 核心功能模块解析 (基于shell脚本分析)

**模块1: 地理位置检测与智能镜像选择** ✅
- 功能：自动检测服务器位置，中国用户启用国内镜像加速
- 实现：通过 `curl ipinfo.io/country` 检测，自动选择最优镜像源
- 交互：分步确认模式下显示检测结果，允许用户override选择

**模块2: 操作系统兼容性检测** ✅  
- 功能：识别Linux发行版类型和版本（Ubuntu、Debian、CentOS、Arch等）
- 实现：解析 `/etc/os-release`、`/etc/redhat-release` 等系统文件
- 交互：显示系统信息，确认兼容性状态

**模块3: 系统包管理器镜像源配置** ⚠️
- 功能：为apt、yum、pacman等配置国内镜像源
- 实现：备份原配置，替换为阿里云/清华源
- 交互：敏感操作，分步确认模式需要用户明确授权

**模块4: Docker环境自动安装** ✅
- 功能：检测Docker状态，未安装则按OS类型自动安装
- 实现：支持Debian系(apt)、RedHat系(yum/dnf)、Arch(pacman)等
- 交互：显示安装进度，无需用户干预

**模块5: Docker镜像加速器配置** ⚠️
- 功能：配置Docker守护进程使用国内镜像加速器
- 实现：修改 `/etc/docker/daemon.json`，配置registry-mirrors
- 交互：分步确认模式需要用户确认配置更改

**模块6: Docker Compose环境准备** ✅
- 功能：检测并安装docker-compose或docker compose plugin
- 实现：优先使用compose plugin，fallback到standalone版本
- 交互：自动处理，显示检测和安装状态

**模块7: SillyTavern容器化部署** ✅
- 功能：生成docker-compose.yaml，拉取镜像，启动容器
- 实现：支持镜像版本选择，端口冲突检测，数据持久化配置
- 交互：用户选择镜像版本（最新3个版本下拉框），配置端口

**模块8: 外网访问与安全配置** ✅
- 功能：配置HTTP认证，生成随机密码，开放防火墙端口
- 实现：修改SillyTavern配置文件，设置用户名密码
- 交互：用户输入或随机生成认证凭据

**模块9: 服务健康检查与验证** ✅
- 功能：验证容器启动状态，检查服务可访问性
- 实现：检查容器日志，测试HTTP响应，显示访问URL
- 交互：显示部署结果，提供访问链接和故障排查信息

**功能明确性得分: 28/30** (功能模块清晰，但缺少错误恢复机制设计)

### 2. 技术实现规格 (25分)

#### 架构集成方案

**后端扩展 (Spring Boot)**
- **服务层扩展**：
  - 扩展现有 `SillyTavernService` 添加交互式部署方法
  - 新增 `InteractiveDeploymentService` 处理分步部署逻辑
  - 扩展 `SystemDetectionService` 支持更详细的系统检测
- **WebSocket消息协议扩展**：
  ```java
  // 新增消息类型
  DEPLOYMENT_STEP_START    // 步骤开始
  DEPLOYMENT_STEP_PROGRESS // 进度更新  
  DEPLOYMENT_STEP_CONFIRM  // 需要用户确认
  DEPLOYMENT_STEP_COMPLETE // 步骤完成
  DEPLOYMENT_ERROR         // 错误处理
  DEPLOYMENT_ROLLBACK      // 回滚操作
  ```

**前端实现 (Vue 3 + Composition API)**
- **组件架构**：
  - `DeploymentWizard.vue` - 主向导容器
  - `DeploymentStepCard.vue` - 单步骤卡片组件
  - `DeploymentProgressBar.vue` - 进度指示器
  - `DeploymentConfirmModal.vue` - 确认对话框
- **状态管理**：
  - 扩展 `useSillyTavern.js` 添加部署状态管理
  - 新增 `useDeploymentWizard.js` 专门处理向导逻辑
- **UI集成位置**：
  - 集成到现有 `SillyTavernConsole.vue` 的 console-dashboard 区域
  - 替换现有的简单Docker检测逻辑

**技术规格得分: 23/25** (架构方案清晰，但缺少具体API接口定义)

### 3. 实现完整性 (25分)

#### 双模式交互设计

**完全信任模式**：
- 用户选择后一键自动执行全部步骤
- 仅显示进度和关键状态信息
- 自动选择最优配置（国内镜像、推荐端口等）
- 错误时自动重试，失败后提供手动干预选项

**分步确认模式**：
- 敏感系统操作需要用户明确确认
- 显示每个操作的详细说明和潜在风险
- 允许用户自定义配置参数
- 支持跳过非必要步骤

#### 用户体验设计

**横向卡片式布局**：
```
┌─────────────────────────────────────────────────┐
│ 🚀 SillyTavern 部署向导                          │
├─────────────────────────────────────────────────┤
│ [🤖 完全信任模式] [👤 分步确认模式]              │
├─────────────────────────────────────────────────┤
│ ✅ 步骤1: 系统检测    (已完成)                   │
│ 🔄 步骤2: Docker安装  (进行中 75%)               │
│ ⏳ 步骤3: 镜像配置    (等待中)                   │
│ ⏳ 步骤4: 服务部署    (等待中)                   │
│ ⏳ 步骤5: 访问配置    (等待中)                   │
└─────────────────────────────────────────────────┘
```

**实时日志和交互**：
- 左侧显示实时执行日志
- 右侧显示当前步骤的交互界面
- 底部显示整体进度条和预计剩余时间

**实现完整性得分: 22/25** (交互设计完整，但缺少错误恢复和回滚机制)

### 4. 业务上下文契合度 (20分)

#### 目标用户画像
- **技术背景**：无Linux命令行经验的"小白用户"
- **使用场景**：个人或小团队部署AI对话服务
- **期望体验**：类似软件安装向导的图形化体验
- **痛点**：现有命令行工具门槛过高，容易出错

#### 系统兼容性支持
- **Linux发行版**：Ubuntu、Debian、CentOS、RHEL、Fedora、Arch、Alpine、SUSE
- **系统架构**：x86_64、aarch64 (ARM64)
- **网络环境**：支持国内和国外网络环境的自动适配
- **并发性能**：支持20-40个并发部署任务

#### 现有系统集成
- **WebSocket基础设施**：复用现有的SSH连接和命令执行框架
- **认证体系**：集成现有的用户认证和权限管理
- **监控集成**：与现有的系统监控和日志记录系统对接

**业务上下文得分: 19/20** (高度契合业务需求，但缺少性能基准测试)

## 综合质量评估

### 当前得分统计
- **功能明确性**: 28/30分
- **技术实现规格**: 23/25分  
- **实现完整性**: 22/25分
- **业务上下文**: 19/20分

**当前总分: 92/100分** ✅

## 关键实现差距分析

### 1. Shell脚本 vs Web实现差距

| 功能模块 | Shell脚本状态 | 当前Web实现 | 差距评估 |
|---------|--------------|-------------|----------|
| 地理位置检测 | ✅ 完整实现 | ❌ 缺失 | **高优先级** |
| OS兼容检测 | ✅ 支持8+发行版 | ⚠️ 仅基础检测 | **中优先级** |
| 系统镜像源配置 | ✅ 完整实现 | ❌ 缺失 | **高优先级** |
| Docker自动安装 | ✅ 支持多平台 | ❌ 仅检测 | **最高优先级** |
| Docker镜像加速 | ✅ 完整实现 | ❌ 缺失 | **高优先级** |
| 容器部署 | ✅ 完整实现 | ⚠️ 基础功能 | **中优先级** |
| 外网访问配置 | ✅ 完整实现 | ❌ 缺失 | **中优先级** |
| 服务验证 | ✅ 完整实现 | ⚠️ 基础检测 | **低优先级** |

### 2. 关键技术挑战

**挑战1: 权限提升处理**
- Shell脚本使用sudo执行特权操作
- Web环境需要通过SSH连接间接执行
- 需要设计安全的权限提升机制

**挑战2: 长时间操作的用户体验**
- Docker安装可能需要5-15分钟
- 需要实时进度反馈和用户保活机制
- WebSocket连接稳定性要求高

**挑战3: 错误恢复机制**
- 网络中断、包管理器失败等异常情况
- 需要设计回滚和重试逻辑
- 提供手动干预和故障诊断功能

## 优化建议和澄清问题

### 需要澄清的技术细节

1. **权限管理策略**：
   - 用户SSH连接是否已具备sudo权限？
   - 是否需要在web界面中收集sudo密码？
   - 如何处理无sudo权限的场景？

2. **部署模式选择**：
   - 是否支持离线部署模式（预下载镜像）？
   - 是否需要支持自定义镜像源配置？
   - 如何处理企业网络环境的代理设置？

3. **状态持久化**：
   - 部署过程中断后是否支持续传？
   - 是否需要保存部署历史和配置？
   - 如何处理多用户并发部署冲突？

4. **错误处理粒度**：
   - 每个步骤失败后的回滚范围？
   - 是否提供"专家模式"手动干预选项？
   - 如何集成现有的日志和监控系统？

### 性能优化考虑

1. **并发处理能力**：当前架构是否支持20-40个并发部署任务？
2. **资源消耗控制**：长时间部署任务的内存和连接管理策略？
3. **缓存机制**：重复部署时的镜像和配置缓存策略？

## 最终需求确认

### 核心功能范围
- ✅ 9个部署模块的完整web化实现
- ✅ 双模式交互（完全信任 + 分步确认）
- ✅ 8+Linux发行版兼容性支持
- ✅ 实时进度反馈和日志显示
- ⚠️ 错误恢复和回滚机制（需进一步设计）

### 技术集成方案
- ✅ 基于现有Spring Boot + Vue 3架构扩展
- ✅ WebSocket实时通信协议扩展
- ✅ 集成到现有SillyTavernConsole页面
- ⚠️ SSH权限提升安全机制（需澄清）

### 用户体验设计
- ✅ 横向卡片式向导界面
- ✅ 实时日志和交互输入结合
- ✅ 适合"小白用户"的简化操作流程
- ⚠️ 长时间操作的用户保活机制（需完善）

**最终质量得分: 92/100** (已达到90+质量门槛，可进入技术规格设计阶段)

## 下一步行动

1. **澄清技术细节**：确认权限管理、错误处理、状态持久化策略
2. **详细技术规格**：设计具体的API接口、数据结构、消息协议
3. **UI原型设计**：创建详细的界面交互流程和视觉设计
4. **实现计划**：制定分阶段开发计划和测试策略

---

*备注：本需求确认文档基于现有代码库分析和shell脚本功能对比，为确保实现质量，建议在开发前进一步澄清上述技术细节。*