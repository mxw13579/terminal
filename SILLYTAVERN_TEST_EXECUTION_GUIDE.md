# SillyTavern核心功能测试套件执行指南

## 测试套件概述

本测试套件为SillyTavern控制台的4个核心功能提供了完整的功能测试覆盖：

### 1. 配置管理功能测试
- **用户名密码修改**: 验证用户名格式（只允许字母和下划线）和密码强度（至少6个字符）
- **配置验证**: 测试各种无效配置的验证和错误提示
- **自动重启**: 验证配置修改后容器自动重启机制
- **并发锁**: 测试并发配置修改的互斥锁机制

### 2. 实时日志查看功能测试
- **WebSocket推送**: 验证实时日志流的WebSocket推送机制
- **条数选择**: 测试500/1000/3000行的日志条数选择
- **级别过滤**: 验证all/error/warn/info的日志级别过滤
- **资源清理**: 测试用户断连后的自动资源清理
- **内存管理**: 验证日志缓存的内存使用管理和自动清理

### 3. 数据管理功能测试
- **SFTP导入导出**: 验证基于SFTP的数据目录导出和ZIP文件创建
- **ZIP验证**: 测试ZIP文件结构验证（必须包含data目录）
- **备份回滚**: 验证导入前自动备份和失败时自动回滚机制
- **大文件处理**: 测试大文件（>100MB）的导入导出操作
- **并发操作**: 验证数据操作的互斥锁机制
- **完整性检查**: 测试数据完整性和一致性验证

### 4. Docker版本管理功能测试
- **版本查询**: 验证GitHub API版本信息查询和最新3个版本显示
- **版本切换**: 测试版本升级和镜像清理功能
- **升级锁**: 验证版本升级的互斥锁机制
- **镜像清理**: 测试Docker未使用镜像的清理操作
- **错误处理**: 验证无效版本、网络超时等异常情况处理
- **数据持久性**: 测试升级过程中的数据持久性保证

## 性能和并发测试

### 并发用户测试
- **20用户并发**: 验证20个用户同时进行不同操作的系统表现
- **40用户高负载**: 测试40个用户的高负载场景性能
- **数据一致性**: 验证并发操作中的数据一致性维护
- **WebSocket负载**: 测试100个WebSocket连接的负载压力
- **持续负载**: 验证60秒持续负载下的系统稳定性

### 性能要求验证
- **响应时间**: 监控更新 < 3秒，操作响应 < 5秒
- **成功率**: 并发操作成功率 >= 90%
- **吞吐量**: 系统吞吐量 >= 8-10 ops/sec
- **内存效率**: 大量日志处理内存使用合理
- **资源清理**: 确保连接和资源正确清理

## 错误处理和边界条件测试

### 网络和连接错误
- SSH连接失败和恢复机制
- Docker daemon不可用处理
- 网络连接超时处理
- GitHub API访问失败处理

### 权限和安全错误
- 权限不足的sudo提示
- 用户输入验证和安全检查
- 文件权限问题处理

### 资源和数据错误
- 磁盘空间不足处理
- 内存资源耗尽场景
- 文件损坏和数据完整性
- 大文件操作超时

### 服务中断和恢复
- 容器状态异常处理
- 服务中断后的恢复机制
- 操作中断的回滚处理

## 测试执行命令

### 1. 完整测试套件
```bash
mvn test -Dtest=SillyTavernCoreFeatureTestSuite
```
运行所有测试，包括单元测试、集成测试、性能测试和错误处理测试。

### 2. 核心功能快速测试
```bash
mvn test -Dtest=SillyTavernServiceTest,SillyTavernStompControllerTest
```
快速验证4个核心功能的基本业务逻辑和WebSocket集成。

### 3. 性能和并发测试
```bash
mvn test -Dtest=SillyTavernPerformanceTest
```
专门测试20-40用户并发场景和系统性能表现。

### 4. 错误处理专项测试
```bash
mvn test -Dtest=SillyTavernErrorHandlingTest
```
验证各种异常情况和边界条件的处理。

### 5. 端到端集成测试
```bash
mvn test -Dtest=SillyTavernWorkflowIntegrationTest
```
测试完整的用户工作流程和系统集成。

### 6. 按功能模块测试
```bash
# 配置管理功能
mvn test -Dtest="*Test" -Dgroups="configuration"

# 实时日志功能
mvn test -Dtest="*Test" -Dgroups="logging"

# 数据管理功能
mvn test -Dtest="*Test" -Dgroups="data-management"

# 版本管理功能
mvn test -Dtest="*Test" -Dgroups="version-management"
```

## 测试验证标准

### 功能正确性验证
- [ ] 所有核心功能按需求规格正确实现
- [ ] 用户输入验证和错误提示用户友好
- [ ] 配置修改后容器自动重启
- [ ] 实时日志推送和过滤正常工作
- [ ] 数据导入导出完整且安全
- [ ] 版本管理和镜像清理有效

### 集成质量验证
- [ ] WebSocket消息路由正确
- [ ] SSH连接管理稳定
- [ ] 与现有终端系统无缝集成
- [ ] 前后端数据交换正确
- [ ] 服务间调用正常

### 性能和并发验证
- [ ] 支持20-40用户并发访问
- [ ] 并发操作成功率 >= 90%
- [ ] 响应时间符合要求（<3-5秒）
- [ ] 系统吞吐量达标（>=8-10 ops/sec）
- [ ] 内存使用效率合理
- [ ] 资源正确清理

### 错误处理验证
- [ ] 所有异常都有友好的错误提示
- [ ] 系统在错误后能正确恢复
- [ ] 数据操作失败时自动回滚
- [ ] 权限问题给出明确指导
- [ ] 网络问题有重试机制

### 安全性验证
- [ ] 用户输入严格验证
- [ ] 权限检查有效
- [ ] 敏感数据正确处理
- [ ] 文件操作安全可控
- [ ] SSH连接安全管理

## 测试报告和分析

测试执行后，查看以下输出信息：

### 1. 测试覆盖率
- 单元测试覆盖: 25+ 方法
- 集成测试覆盖: 20+ 方法  
- 错误处理测试: 15+ 方法
- 性能测试覆盖: 6+ 方法
- 总测试方法数: 70+ 个

### 2. 性能指标
- 20用户并发成功率: >= 90%
- 40用户平均响应时间: < 5秒
- 系统吞吐量: >= 8 ops/sec
- 持续负载成功率: >= 95%
- WebSocket连接处理: 100个连接无问题

### 3. 功能验证结果
- 配置管理: 用户名/密码验证、自动重启
- 实时日志: WebSocket推送、级别过滤、资源清理
- 数据管理: SFTP操作、ZIP验证、备份回滚
- 版本管理: GitHub API、镜像清理、升级锁

### 4. 错误处理覆盖
- 网络连接问题: SSH、Docker、GitHub API
- 权限问题: Sudo要求、文件权限
- 资源问题: 磁盘空间、内存使用
- 数据问题: 文件损坏、格式错误

## 故障排除

### 常见测试失败原因

1. **Mock设置问题**
   - 检查所有服务Mock是否正确设置
   - 验证Mock返回值与实际DTO结构匹配

2. **并发测试超时**
   - 增加测试超时时间
   - 检查ExecutorService配置

3. **WebSocket消息验证失败**
   - 确认消息队列名称正确
   - 检查消息格式和内容验证逻辑

4. **性能测试不稳定**
   - 调整并发用户数量
   - 增加测试等待时间

### 测试环境要求

- Java 17+
- Maven 3.6+
- Spring Boot 3.0.2
- 充足的系统内存（>2GB可用）
- 稳定的网络连接

## 持续集成配置

### Jenkins/GitHub Actions配置
```yaml
- name: Run SillyTavern Tests
  run: |
    mvn test -Dtest=SillyTavernCoreFeatureTestSuite
    mvn test -Dtest=SillyTavernPerformanceTest
```

### 测试结果分析
- 解析测试报告
- 生成覆盖率报告
- 性能指标趋势分析
- 失败测试分析和修复建议

通过这个完整的测试套件，可以确保SillyTavern控制台的4个核心功能在实际部署前经过充分验证，满足功能正确性、集成质量、并发支持和错误处理的所有要求。